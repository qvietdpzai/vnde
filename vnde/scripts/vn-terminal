#!/usr/bin/env bash
set -euo pipefail

VN_BASHRC="$HOME/.config/vnde/vn-bashrc"
mkdir -p "$HOME/.config/vnde"

if [[ ! -f "$VN_BASHRC" ]]; then
  cat > "$VN_BASHRC" <<'BRC'
export LANG=vi_VN.UTF-8
export LC_TIME=vi_VN.UTF-8
HISTSIZE=20000
HISTFILESIZE=40000
HISTCONTROL=ignoredups:erasedups
shopt -s histappend checkwinsize
PROMPT_COMMAND='history -a; history -n'

parse_git_branch() { git rev-parse --abbrev-ref HEAD 2>/dev/null; }
__vnde_ps1() {
  local branch
  branch="$(parse_git_branch)"
  if [[ -n "$branch" ]]; then
    printf "\\[\\e[1;31m\\]%s\\[\\e[0m\\]@\\[\\e[1;32m\\]vnde\\[\\e[0m\\]:\\[\\e[1;33m\\]%s\\[\\e[0m\\] \\[\\e[1;36m\\](%s)\\[\\e[0m\\]\\$ " "\\u" "\\w" "$branch"
  else
    printf "\\[\\e[1;31m\\]%s\\[\\e[0m\\]@\\[\\e[1;32m\\]vnde\\[\\e[0m\\]:\\[\\e[1;33m\\]%s\\[\\e[0m\\]\\$ " "\\u" "\\w"
  fi
}
PS1='$(__vnde_ps1)'

if command -v eza >/dev/null 2>&1; then
  alias ls='eza --group-directories-first'
  alias ll='eza -al --group-directories-first --git'
else
  alias ll='ls -alF'
  alias la='ls -A'
  alias l='ls -CF'
fi

alias gs='git status -sb'
alias dps='docker ps'
alias ports='ss -tulpn'
mkcd() { mkdir -p "$1" && cd "$1"; }
newscli() { vn-news-cli "${1:-vnexpress}"; }
vn_web_search() {
  local q="${*:-}"
  [[ -z "$q" ]] && return 0
  local enc
  enc="$(python3 -c 'import sys, urllib.parse; print(urllib.parse.quote_plus(" ".join(sys.argv[1:])))' "$q")"
  xdg-open "https://www.google.com/search?q=$enc" >/dev/null 2>&1 &
}
vn_web_search_prompt() {
  local q
  read -erp "Tim tren internet: " q
  [[ -n "$q" ]] && vn_web_search "$q"
}
search() { vn_web_search "$*"; }

# Readline quality-of-life, including better paste handling
bind 'set enable-bracketed-paste on'
bind 'set completion-ignore-case on'
bind -x '"\eg":vn_web_search_prompt'

echo "Xin chao! Day la VN Terminal Pro."
echo "Tip: newscli, mkcd <dir>, dps, gs, search <tu khoa>, Alt+g"
BRC
fi

if [[ "${1:-}" == "-e" ]]; then
  shift
  CMD="$*"
elif [[ "${1:-}" == "--readonly" ]]; then
  shift
  CMD="bash --restricted"
else
  CMD=""
fi

# For reliable mouse-left paste support, prefer xterm mode when available.
if command -v xterm >/dev/null 2>&1; then
  XRM1='XTerm*selectToClipboard: true'
  XRM2=$'XTerm*VT100.translations: #override\n<Btn1Up>:insert-selection(CLIPBOARD)\n<Btn3Down>:exec-formatted("vn-terminal-context-menu")'
  if [[ -n "$CMD" ]]; then
    exec xterm -xrm "$XRM1" -xrm "$XRM2" -fa "Noto Sans Mono" -fs 11 -bg "#0F1A14" -fg "#F5F0DC" -title "VN Terminal" -e bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec xterm -xrm "$XRM1" -xrm "$XRM2" -fa "Noto Sans Mono" -fs 11 -bg "#0F1A14" -fg "#F5F0DC" -title "VN Terminal" -e bash --rcfile "$VN_BASHRC"
elif command -v kitty >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec kitty --title "VN Terminal" bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec kitty --title "VN Terminal" bash --rcfile "$VN_BASHRC"
elif command -v alacritty >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec alacritty -e bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec alacritty -e bash --rcfile "$VN_BASHRC"
else
  if [[ -n "$CMD" ]]; then
    exec bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec bash --rcfile "$VN_BASHRC"
fi
