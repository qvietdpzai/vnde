#!/usr/bin/env bash
set -euo pipefail

VN_BASHRC="$HOME/.config/vnde/vn-bashrc"
mkdir -p "$HOME/.config/vnde"

if [[ ! -f "$VN_BASHRC" ]]; then
  cat > "$VN_BASHRC" <<'BRC'
export LANG=vi_VN.UTF-8
export LC_TIME=vi_VN.UTF-8
# History quality-of-life
HISTSIZE=20000
HISTFILESIZE=40000
HISTCONTROL=ignoredups:erasedups
shopt -s histappend checkwinsize
PROMPT_COMMAND='history -a; history -n'

# Prompt with git branch
parse_git_branch() {
  git rev-parse --abbrev-ref HEAD 2>/dev/null
}
__vnde_ps1() {
  local branch
  branch="$(parse_git_branch)"
  if [[ -n "$branch" ]]; then
    printf "\\[\\e[1;31m\\]%s\\[\\e[0m\\]@\\[\\e[1;32m\\]vnde\\[\\e[0m\\]:\\[\\e[1;33m\\]%s\\[\\e[0m\\] \\[\\e[1;36m\\](%s)\\[\\e[0m\\]\\$ " "\\u" "\\w" "$branch"
  else
    printf "\\[\\e[1;31m\\]%s\\[\\e[0m\\]@\\[\\e[1;32m\\]vnde\\[\\e[0m\\]:\\[\\e[1;33m\\]%s\\[\\e[0m\\]\\$ " "\\u" "\\w"
  fi
}
PS1='$(__vnde_ps1)'

# Smart aliases
if command -v eza >/dev/null 2>&1; then
  alias ls='eza --group-directories-first'
  alias ll='eza -al --group-directories-first --git'
  alias tree='eza --tree'
else
  alias ll='ls -alF'
  alias la='ls -A'
  alias l='ls -CF'
fi
if command -v batcat >/dev/null 2>&1; then alias cat='batcat --style=plain'; fi
if command -v bat >/dev/null 2>&1; then alias cat='bat --style=plain'; fi

alias ..='cd ..'
alias ...='cd ../..'
alias c='clear'
alias gs='git status -sb'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gd='git diff'
alias gco='git checkout'
alias dps='docker ps'
alias dimg='docker images'
alias ports='ss -tulpn'
alias myip='curl -s ifconfig.me; echo'

mkcd() { mkdir -p "$1" && cd "$1"; }
extract() {
  case "$1" in
    *.tar.bz2) tar xjf "$1" ;;
    *.tar.gz)  tar xzf "$1" ;;
    *.bz2)     bunzip2 "$1" ;;
    *.rar)     unrar x "$1" ;;
    *.gz)      gunzip "$1" ;;
    *.tar)     tar xf "$1" ;;
    *.tbz2)    tar xjf "$1" ;;
    *.tgz)     tar xzf "$1" ;;
    *.zip)     unzip "$1" ;;
    *.7z)      7z x "$1" ;;
    *)         echo "Khong ho tro: $1" ;;
  esac
}
weather() { curl -s "wttr.in/${1:-Hanoi}?0"; }
newscli() { vn-news-cli "${1:-vnexpress}"; }

# fzf helpers when available
if command -v fzf >/dev/null 2>&1; then
  [ -f /usr/share/doc/fzf/examples/key-bindings.bash ] && source /usr/share/doc/fzf/examples/key-bindings.bash
  [ -f /usr/share/doc/fzf/examples/completion.bash ] && source /usr/share/doc/fzf/examples/completion.bash
fi

echo "Xin chao! Day la VN Terminal Pro."
echo "Tip: dung 'newscli', 'weather <city>', 'mkcd <dir>', 'extract <file>'."
BRC
fi

if [[ "${1:-}" == "-e" ]]; then
  shift
  CMD="$*"
else
  CMD=""
fi

if command -v kitty >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec kitty --title "VN Terminal" bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec kitty --title "VN Terminal" bash --rcfile "$VN_BASHRC"
elif command -v alacritty >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec alacritty -e bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec alacritty -e bash --rcfile "$VN_BASHRC"
elif command -v xterm >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec xterm -fa "Noto Sans Mono" -fs 11 -bg "#0F1A14" -fg "#F5F0DC" -title "VN Terminal" -e bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec xterm -fa "Noto Sans Mono" -fs 11 -bg "#0F1A14" -fg "#F5F0DC" -title "VN Terminal" -e bash --rcfile "$VN_BASHRC"
else
  if [[ -n "$CMD" ]]; then
    exec bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec bash --rcfile "$VN_BASHRC"
fi
