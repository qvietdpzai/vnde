#!/usr/bin/env bash
set -euo pipefail

VN_BASHRC="$HOME/.config/vnde/vn-bashrc"
mkdir -p "$HOME/.config/vnde"

cat > "$VN_BASHRC" <<'BRC'
export LANG=vi_VN.UTF-8
export LC_TIME=vi_VN.UTF-8
HISTSIZE=20000
HISTFILESIZE=40000
HISTCONTROL=ignoredups:erasedups
shopt -s histappend checkwinsize
PROMPT_COMMAND='history -a; history -n'

# Keep prompt/behavior close to normal terminal.
if [[ -f "$HOME/.bashrc" ]]; then
  # shellcheck disable=SC1090
  source "$HOME/.bashrc"
fi

if command -v eza >/dev/null 2>&1; then
  alias ls='eza --group-directories-first'
  alias ll='eza -al --group-directories-first --git'
else
  alias ll='ls -alF'
  alias la='ls -A'
  alias l='ls -CF'
fi

alias gs='git status -sb'
alias dps='docker ps'
alias ports='ss -tulpn'
mkcd() { mkdir -p "$1" && cd "$1"; }
newscli() { vn-news-cli "${1:-vnexpress}"; }
vn_web_search() {
  local q="${*:-}"
  [[ -z "$q" ]] && return 0
  local enc
  enc="$(python3 -c 'import sys, urllib.parse; print(urllib.parse.quote_plus(" ".join(sys.argv[1:])))' "$q")"
  xdg-open "https://www.google.com/search?q=$enc" >/dev/null 2>&1 &
}
vn_web_search_prompt() {
  local q
  read -erp "Tim tren internet: " q
  [[ -n "$q" ]] && vn_web_search "$q"
}
vn_context_menu() {
  local menu_cmd="$HOME/.local/bin/vn-terminal-context-menu"
  if [[ -x "$menu_cmd" ]]; then
    "$menu_cmd"
  fi
}
search() { vn_web_search "$*"; }
menu() { vn_context_menu; }

# Readline quality-of-life, including better paste handling
bind 'set enable-bracketed-paste on'
bind 'set completion-ignore-case on'
bind -x '"\eg":vn_web_search_prompt'
bind -x '"\es":vn_web_search_prompt'
bind -x '"\e[19~":vn_web_search_prompt'
bind -x '"\C-g":vn_context_menu'
alias web='vn_web_search'

echo "Xin chao! Day la VN Terminal Pro."
echo "Tip: search/web <tu khoa> | menu/Ctrl+g: Menu | di chuyen: vn-terminal-context-menu --move left|right|up|down"
BRC

if [[ "${1:-}" == "-e" ]]; then
  shift
  CMD="$*"
elif [[ "${1:-}" == "--readonly" ]]; then
  shift
  CMD="bash --restricted"
else
  CMD=""
fi

if command -v gnome-terminal >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec gnome-terminal --title="VN Terminal" -- bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec gnome-terminal --title="VN Terminal" -- bash --rcfile "$VN_BASHRC" -i
elif command -v x-terminal-emulator >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec x-terminal-emulator -e bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec x-terminal-emulator -e bash --rcfile "$VN_BASHRC" -i
elif command -v xterm >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec xterm -fa "Noto Sans Mono" -fs 11 -bg "#0F1A14" -fg "#F5F0DC" -title "VN Terminal" -e bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec xterm -fa "Noto Sans Mono" -fs 11 -bg "#0F1A14" -fg "#F5F0DC" -title "VN Terminal" -e bash --rcfile "$VN_BASHRC"
elif command -v kitty >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec kitty --title "VN Terminal" bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec kitty --title "VN Terminal" bash --rcfile "$VN_BASHRC"
elif command -v alacritty >/dev/null 2>&1; then
  if [[ -n "$CMD" ]]; then
    exec alacritty -e bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec alacritty -e bash --rcfile "$VN_BASHRC"
else
  if [[ -n "$CMD" ]]; then
    exec bash --rcfile "$VN_BASHRC" -ic "$CMD; exec bash --rcfile '$VN_BASHRC'"
  fi
  exec bash --rcfile "$VN_BASHRC"
fi
